<!DOCTYPE html>
<html>
<head>
<title>KeyPass</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link
rel="stylesheet"
href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap"
/>
<style>
@keyframes flicker {
0%,
19%,
21%,
23%,
25%,
54%,
56%,
100% {
text-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00, 0 0 20px #00ff00,
0 0 40px #00c800, 0 0 80px #00c800;
opacity: 1;
}
20%,
24%,
55% {
text-shadow: none;
opacity: 0.6;
}
}

@keyframes glitch {
0% {
transform: translate(0);
}
20% {
transform: translate(-3px, 3px);
}
40% {
transform: translate(-3px, -3px);
}
60% {
transform: translate(3px, 3px);
}
80% {
transform: translate(3px, -3px);
}
100% {
transform: translate(0);
}
}

@keyframes scanline {
0% {
background-position: 0 0;
}
100% {
background-position: 0 100%;
}
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
background-color: #050a05;
color: #c0fcc0;
font-family: "Roboto Mono", monospace;
min-height: 100vh;
display: flex;
flex-direction: column;
align-items: center;
padding: 20px;
position: relative;
overflow: hidden;
}

body::before {
content: "";
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-image: linear-gradient(
0deg,
rgba(0, 255, 0, 0.1) 1px,
transparent 1px
);
background-size: 100% 3px;
animation: scanline 10s linear infinite;
pointer-events: none;
z-index: -1;
}

.container {
width: 100%;
max-width: 600px;
}

.header {
text-align: center;
margin-bottom: 40px;
}

h1 {
font-size: 2.8rem;
font-weight: 700;
color: #00ff00;
text-transform: uppercase;
animation: flicker 4s linear infinite;
}

.subtitle {
color: #8a9a8a;
font-size: 1.1rem;
}

.glass-panel,
.modern-btn,
.password-card {
background: rgba(0, 20, 0, 0.5);
border: 1px solid rgba(0, 255, 0, 0.4);
border-radius: 0;
backdrop-filter: blur(5px);
transition: all 0.2s ease;
}

.modern-btn:hover,
.password-card:hover {
background: rgba(0, 50, 0, 0.7);
color: #fff;
animation: glitch 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
}

.modern-btn {
padding: 12px 20px;
color: #00ff00;
font-weight: 700;
font-size: 16px;
cursor: pointer;
text-transform: uppercase;
}

.menu-btn {
border-color: rgba(0, 255, 0, 0.7) !important;
}

.glass-panel {
padding: 30px;
}

.form-group {
margin-bottom: 20px;
}

label {
display: block;
color: #00ff00;
font-weight: 700;
margin-bottom: 8px;
font-size: 14px;
text-transform: uppercase;
}

input,
select {
width: 100%;
padding: 15px;
background: #050a05;
border: 1px solid rgba(0, 255, 0, 0.4);
border-radius: 0;
color: #c0fcc0;
font-size: 16px;
font-family: "Roboto Mono", monospace;
}

input:focus,
select:focus {
outline: 1px solid #00ff00;
box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
}

select option {
background: #050a05;
color: #c0fcc0;
}

.submit-btn {
width: 100%;
padding: 15px;
background: #00ff00;
border: none;
color: #050a05;
font-weight: 700;
font-size: 16px;
cursor: pointer;
text-transform: uppercase;
}

.password-grid {
display: grid;
grid-template-columns: 1fr;
gap: 10px;
}

.password-card {
padding: 20px;
cursor: pointer;
user-select: none;
text-align: center;
}

.password-name {
color: #c0fcc0;
font-weight: 700;
font-size: 18px;
text-shadow: 0 0 5px rgba(0, 255, 0, 0.7);
}
.password-card:hover .password-name {
color: #fff;
}

.hidden {
display: none !important;
}

.loading {
display: inline-block;
width: 20px;
height: 20px;
border: 2px solid rgba(0, 255, 0, 0.3);
border-radius: 50%;
border-top-color: #00ff00;
animation: spin 1s linear infinite;
}
@keyframes spin {
to {
transform: rotate(360deg);
}
}

summary {
cursor: pointer;
color: #00ff00;
font-weight: 700;
padding: 10px;
border: 1px solid rgba(0, 255, 0, 0.4);
margin-top: 20px;
}

.password-grid {
counter-reset: password-counter;
}

.password-card {
display: flex;
align-items: baseline;
padding: 15px 20px;
text-align: left;
}

.password-card::before {
counter-increment: password-counter;
content: counter(password-counter, decimal-leading-zero);
color: #8a9a8a;
font-weight: 700;
margin-right: 15px;
min-width: 25px;
}

.password-prompt {
color: #00ff00;
font-weight: 700;
margin-right: 15px;
}

.password-name {
flex-grow: 1;
}

.password-card {
display: flex;
justify-content: space-between;
align-items: center;
}

.password-details {
display: flex;
align-items: baseline;
flex-grow: 1;
cursor: pointer;
}

.edit-btn {
background: none;
border: 1px solid rgba(0, 255, 0, 0.4);
color: #00ff00;
font-size: 120%;
width: 40px;
height: 40px;
cursor: pointer;
margin-left: 15px;
transition: all 0.2s ease;
}

.edit-btn:hover {
background: rgba(0, 50, 0, 0.7);
color: #fff;
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>KeyPass</h1>
<p id="subtitle" class="subtitle">Password Management System</p>

<button
id="add-button"
onclick="shake('add-button'); toggleCreatePassForm()"
class="modern-btn menu-btn"
role="button"
style="
position: absolute;
top: 20px;
left: 20px;
padding: 0;
font-size: 200%;
width: 50px;
height: 50px;
z-index: 10;
"
>
+
</button>
<button
id="settings-button"
onclick="shake('settings-button'); toggleSettings()"
class="modern-btn menu-btn"
role="button"
style="
position: absolute;
top: 20px;
right: 20px;
padding: 0;
font-size: 200%;
width: 50px;
height: 50px;
z-index: 10;
"
>
&#9881;
</button>
</div>
<div class="mainScreen hidden" id="settingsForm">
<div class="glass-panel button-column">
<button
class="modern-btn column togglableButton"
role="button"
data-setting="confirm_actions"
data-enabled-text="Confirm actions"
data-disabled-text="Just run actions"
>
Ask for confirmations
</button>
<button
class="modern-btn column togglableButton"
role="button"
data-setting="password_visibility"
data-enabled-text="Show passwords"
data-disabled-text="Hide passwords"
>
Ask for confirmations
</button>
<button
class="modern-btn column"
role="button"
onclick="window.location.pathname = '/dump'"
style="background: rgba(107, 255, 107, 0.2)"
>
Backup passwords blob
</button>
<button
class="modern-btn column"
role="button"
onclick="toggleWifiPassForm()"
>
Change Wi-Fi password
</button>
<div
id="wifiPassForm"
class="hidden"
style="overflow: hidden; transition: all 0.3s ease-out"
>
<div class="glass-panel" style="margin-top: 10px">
<div class="form-group">
<input
class="passwordLength"
type="password"
id="newWifiPass"
placeholder="New Wi-Fi password"
minlength="8"
maxlength="31"
required
/>
<input
class="passwordLength"
type="password"
id="confirmWifiPass"
placeholder="Confirm password"
minlength="8"
maxlength="31"
required
/>
<button
type="button"
onclick="updateWifiPass()"
class="submit-btn"
>
<span class="btn-text">Update Password</span>
<span class="loading hidden"></span>
</button>
</div>
</div>
</div>
<button
class="modern-btn column"
role="button"
onclick="checkPassphrase({force:true})"
style="background: rgba(255, 107, 107, 0.2)"
>
Reset passphrase
</button>
<button
class="modern-btn column"
role="button"
onclick="confirmFactoryReset()"
style="background: rgba(255, 107, 107, 0.2)"
>
Factory Reset
</button>
<div id="passwdRecoveryInputs">
<input type="file" id="blobFileInput" />
<textarea
id="blobTextInput"
placeholder="Paste blob file content here..."
rows="4"
style="width: 100%; display: none"
></textarea>
</div>
<button
class="modern-btn column"
role="button"
onclick="uploadBlobFile()"
>
Recover passwords from blob
</button>
<button
class="modern-btn column"
role="button"
onclick="alert(localStorage.getItem('keypass_passphrase'))"
>
Show passphrase
</button>
</div>
</div>

<div class="mainScreen hidden" id="editForm">
<div class="glass-panel">
<form id="editFormContent" method="get" action="/editPass">
<input type="hidden" name="id" id="positionSelect" disabled />

<div class="form-group">
<label for="passLabel">Name</label>
<input
class="passwordLength"
id="passLabel"
name="name"
type="text"
required
placeholder="Enter password name"
maxlength="29"
/>

<label for="passwordInput">Password</label>
<div style="display: flex; gap: 10px">
<input
class="passwordLength"
id="passwordInput"
type="password"
name="password"
placeholder="Enter password..."
maxlength="31"
/>

<button
id="toggleVisibilityIcon"
type="button"
class="modern-btn togglableButton"
data-setting="password_visibility"
data-enabled-text="&#x1F640;"
data-disabled-text="&#x1f648;"
data-changed="togglePasswordVisibility"
style="
width: 50px;
flex: 0 0 auto;
padding: 0;
font-size: 200%;
"
>
&#x1f648;
</button>
<button
type="button"
onclick="generatePass(this)"
class="modern-btn"
style="
width: 60px;
flex: 0 0 auto;
padding: 0;
font-size: 180%;
"
>
&#127922;
</button>
</div>
<div style="display: flex; gap: 10px; margin-top: 10px">
<button
id="typeNewPassBtn"
type="button"
onclick="typeNewPass()"
class="modern-btn hidden"
style="width: auto; flex: auto"
>
<span style="vertical-align: -15%; font-size: 200%">
&#x2328;</span
>&nbsp;&nbsp;Type
</button>
<button
id="typeOldPassBtn"
type="button"
onclick="typeOldPass()"
class="modern-btn hidden"
style="width: auto; flex: auto"
>
<span style="vertical-align: -15%; font-size: 200%"
>&#x2328;</span
>&nbsp;&nbsp;Type current (already registered)
</button>
</div>
<label for="layoutSelect">Keyboard layout</label>
<select name="lang" id="layoutSelect" required>
<option value="bitlocker">F1-F12 (bitlocker)</option>
<option value="fr">French</option>
<option value="us">US</option>
</select>
<input type="hidden" name="layout" id="layoutIndex" />
</div>
<button type="submit" class="submit-btn">
<span class="btn-text">Save Password</span>
<span class="loading hidden"></span>
</button>
</form>
</div>
</div>

<div id="passList" class="mainScreen">
<div class="password-grid">
<!-- Passwords will be loaded here -->
</div>
<details id="advancedTypingOptions" style="padding: 1ex">
<summary>Advanced options</summary>
<div class="form-group">
<p style="padding: 1ex"></p>
<div>
<label for="typePasswordPressEnter"
>After typing a password:</label
>
<button
id="typePasswordPressEnter"
class="modern-btn column togglableButton"
role="button"
data-setting="press_enter"
data-enabled-text="Press &crarr;"
data-disabled-text="Do not press &crarr;"
></button>
</div>
<p style="padding: 1ex">
<label for="layoutOverrideSelect"
>Keyboard layout override:</label
>
<select name="lang" id="layoutOverrideSelect" required>
<option value="">Password specific</option>
<option value="fr">French</option>
<option value="us">US</option>
</select>
</p>
</div>
<p>&nbsp;</p>
</details>
</div>
</div>
<script>
<!-- WARN: The following line must not be changed and is replaced with index.js content automatically -->
const MAX_PASSWORD_LENGTH=31;const UserPreferences={defaults:{confirm_actions:true,password_visibility:false,password_length:12,},save:function(key,value){localStorage.setItem(`userPref_${key}`,JSON.stringify(value));},get:function(key){const stored=localStorage.getItem(`userPref_${key}`);return stored?JSON.parse(stored):this.defaults[key];},reset:function(){Object.keys(this.defaults).forEach((key)=>{this.save(key,this.defaults[key]);});},};const ui_data={mode:"type",current_focus:"type-button",passwords:[],change_focus(elementId){document.querySelectorAll(".modern-btn").forEach((btn)=>{btn.classList.remove("active");});const newFocus=document.getElementById(elementId);if(!newFocus)return false;newFocus.classList.add("active");this.current_focus=elementId;},};function errorHandler(error){alert("Error: "+error);}
function getRandomChar(){const charset="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0"+"123456789!@#$%^&*()_+-=[]{}|;:,.<>?";const charsetSize=charset.length;return charset[Math.floor(Math.random()*charsetSize)];}
function generatePassword(length){let password="";for(let i=0;i<length;++i){password+=getRandomChar();}
return password;}
function generatePass(buttonElement){const uid=~~document.getElementById("positionSelect").value;let length=document.getElementById("passwordInput").value.length||ui_data.passwords[uid]?.len||prompt("How many characters ?",18);if(!length||isNaN(length)||length<2){return;}
if(length>MAX_PASSWORD_LENGTH)length=MAX_PASSWORD_LENGTH;shake(buttonElement);const password=generatePassword(length);document.getElementById("passwordInput").value=password;document.getElementById("typeNewPassBtn").classList.remove("hidden");if(ui_data.mode!="add")
document.getElementById("typeOldPassBtn").classList.remove("hidden");}
function shake(elementId="diceIcon"){const icon=typeof elementId=="string"?document.getElementById(elementId):elementId;icon.classList.add("wiggle");setTimeout(()=>{icon.classList.remove("wiggle");},500);}
function toggleButton(buttonElement,options={}){const setting=buttonElement.getAttribute("data-setting")||options.setting;const currentState=UserPreferences.get(setting)!==false;const newState=options.noflip?currentState:!currentState;UserPreferences.save(setting,newState);const mode=newState?"enabled":"disabled";buttonElement.textContent=buttonElement.getAttribute(`data-${mode}-text`);shake(buttonElement);const fn=buttonElement.getAttribute("data-changed")||"()=>{}";eval(fn)(newState);}
async function togglePasswordVisibility(visible){passwordInput.type=visible?"text":"password";if(ui_data.mode=="edit"&&passwordInput.value.length==0){const pass=await fetch(`/fetchPass?id=${positionSelect.value}`);passwordInput.value=await pass.text();}}
function initToggleButtons(){const elements=document.querySelectorAll(".togglableButton");elements.forEach((button)=>{toggleButton(button,{noflip:true});button.addEventListener("click",()=>{toggleButton(button);});});}
function hideAll(){Array.from(document.getElementsByClassName("mainScreen")).forEach(hideElement,);}
function hideElement(elementId){const el=typeof elementId=="string"?document.getElementById(elementId):elementId;if(!el.classList.contains("hidden")){el.classList.add("hidden");}}
function showElement(elementId){const el=typeof elementId=="string"?document.getElementById(elementId):elementId;if(el.classList.contains("hidden")){el.classList.remove("hidden");}}
function showPasswords(){if(document.getElementById("passList").classList.contains("hidden")){hideAll();setTimeout(()=>showElement("passList"),100);}}
function leaveEditForm(uid){layoutSelect.selectedIndex=1;passwordInput.value="";}
function showEditForm(uid){if(document.getElementById("editForm").classList.contains("hidden")){positionSelect.value=uid;positionSelect.disabled=true;hideAll();setTimeout(()=>showElement("editForm"),300);}}
function setMode(action){if(ui_data.mode==action){return;}
if(ui_data.mode=="edit"||ui_data.mode=="add"){leaveEditForm();}
if(ui_data.mode=="type"){hideElement(advancedTypingOptions);}
ui_data.mode=action;ui_data.change_focus(`${action}-button`);switch(action){case"edit":showPasswords();break;case"type":showElement("advancedTypingOptions");showPasswords();break;case"add":const uid=ui_data.passwords.length;fillForm({name:""});showEditForm(uid);break;case"settings":showSettings();break;default:console.error("Invalid action");}}
function showSettings(){if(document.getElementById("settingsForm").classList.contains("hidden")){hideAll();setTimeout(()=>showElement("settingsForm"),300);}}
function fillForm(data){if(data.layout!=undefined)layoutSelect.selectedIndex=data.layout+1;if(data.uid!=undefined){positionSelect.value=data.uid;}else{positionSelect.value=-1;}
if(data.name!=undefined)passLabel.value=data.name;}
async function checkPassphrase(opts){const{force}=opts||{};const storedPassphrase=localStorage.getItem("keypass_passphrase");if(!storedPassphrase||force){const newPassphrase=prompt("Please set up a passphrase to secure your passwords:",);if(newPassphrase){await setPassPhrase(newPassphrase);localStorage.setItem("keypass_passphrase",newPassphrase);return true;}else{alert("A passphrase is required to use KeyPass.");return await checkPassphrase();}}else{await setPassPhrase(storedPassphrase);return true;}}
async function setPassPhrase(phrase){return fetch("/passphrase",{method:"POST",headers:{"Content-Type":"application/json",},body:JSON.stringify({p:phrase}),}).catch(errorHandler);}
function typeOldPass(){const uid=positionSelect.value;fetch(`/typePass?id=${uid}`).catch(errorHandler);}
function typeNewPass(){const password=passwordInput.value;const escaped=encodeURIComponent(password);const layout=layoutSelect.value;fetch(`/typeRaw?text=${escaped}&layout=${layout}`).catch(errorHandler);}
function passwordClick(event,uid){const card=event.target.closest(".password-card");if(!card)return;uid=parseInt(card.dataset.passwordId);if(event.target.closest(".edit-btn")){if(ui_data.mode!=="edit"){setMode("edit");}
fillForm({uid:uid,name:ui_data.passwords[uid].name,layout:ui_data.passwords[uid].layout,});showEditForm(uid);}else{card.style.transform="scale(0.98)";setTimeout(()=>{card.style.transform="";},150);const layout=layoutOverrideSelect.selectedIndex;const press_enter=UserPreferences.get("press_enter");const prefix=`/typePass?id=${uid}&ret=${press_enter}`;const url=layout>0?`${prefix}&layout=${layout - 1}`:prefix;fetch(url).catch(errorHandler);}}
function updateWifiPass(){const newPass=newWifiPass.value;const confirmPass=confirmWifiPass.value;if(!newPass)return;if(newPass!==confirmPass){alert("Passwords do not match. Please try again.");return;}
if(newPass.length<8){alert("Password must be at least 8 characters long.");return;}
fetch(`/updateWifiPass?newPass=${newPass}`).then((response)=>response.text()).catch(errorHandler);const loadingEl=document.querySelector("#wifiPassForm .loading");const btnText=document.querySelector("#wifiPassForm .btn-text");if(loadingEl&&btnText){btnText.classList.add("hidden");loadingEl.classList.remove("hidden");}
setTimeout(()=>{toggleWifiPassForm();newWifiPass.value="";confirmWifiPass.value="";if(loadingEl&&btnText){btnText.classList.remove("hidden");loadingEl.classList.add("hidden");}},1000);}
function toggleCreatePassForm(){if(ui_data.mode==="add"){setMode("type");}else{setMode("add");}}
function toggleSettings(){if(ui_data.mode==="settings"){setMode("type");}else{setMode("settings");}}
async function getPasswords(){try{const req=await fetch("/list");const passwords=await req.json();passwords.passwords.sort((a,b)=>a.name.localeCompare(b.name));ui_data.passwords=passwords.passwords;const count=passwords.passwords.length;const total=passwords.free+count;subtitle.innerText=`[${count}/${total}] PASSWORDS LOADED`;if(passwords.passwords.length===0){return setMode("add");}
const passList=document.querySelector("#passList .password-grid");const domData=passwords.passwords.map((pass)=>`
  <div class="password-card" data-password-id="${pass.uid}">
      <div class="password-details" role="button">
        <span class="password-prompt">&gt;</span>
        <div class="password-name">${pass.name}</div>
      </div>
      <button class="edit-btn" role="button">&#9998;</button>
  </div>
`).join("");passList.innerHTML=domData;}catch(error){alert("Error: Unable to fetch passwords. Please try again later."+error);}}
function confirmFactoryReset(){if(confirm("Are you sure you want to factory reset KeyPass? This will delete ALL your saved passwords!",)){if(confirm("FINAL WARNING: This action cannot be undone. Proceed with factory reset?",)){fetch("/reset").then((response)=>{if(response.ok){alert("Factory reset successful. The device will reload the page.");setTimeout(()=>window.location.reload(),1000);}else{alert("Factory reset failed.");}}).catch(errorHandler);}}}
function uploadBlobFile(){passwdRecoveryInputs.style.display="block";let contentToUpload;let contentSource;if(blobFileInput.files&&blobFileInput.files.length>0){contentToUpload=blobFileInput.files[0];contentSource="file";}
else if(blobTextInput.value.trim()){const pastedText=blobTextInput.value.trim();contentToUpload=new Blob([pastedText],{type:"text/plain"});contentSource="text";}
else{alert("Please select a file or paste blob content first.");return;}
const button=document.querySelector('button[onclick="uploadBlobFile()"]');const originalText=button.textContent;button.textContent="Uploading...";button.disabled=true;fetch("/restore",{method:"POST",headers:{"Content-Type":"application/octet-stream"},body:contentToUpload,}).then((response)=>{if(!response.ok){throw new Error(`Server responded with ${response.status}: ${response.statusText}`,);}
return response.text();}).then((result)=>{blobFileInput.value="";blobTextInput.value="";button.textContent=originalText;button.disabled=false;alert(result);setTimeout(()=>{window.location.reload();},1000);}).catch((error)=>{button.textContent=originalText;button.disabled=false;alert(`Error: ${error.message}`);});}
function initializeRecoveryInputs(){const container=document.getElementById("passwdRecoveryInputs");container.style.display="none";container.style.marginTop="10px";container.style.marginBottom="10px";blobFileInput.style.display="none";const buttonRow=document.createElement("div");buttonRow.className="button-row";buttonRow.style.marginBottom="10px";const fileButton=document.createElement("button");fileButton.className="modern-btn";fileButton.textContent="Select File";fileButton.onclick=function(e){e.preventDefault();blobFileInput.click();};const textButton=document.createElement("button");textButton.className="modern-btn";textButton.textContent="Use Text Input";textButton.onclick=function(e){blobTextInput.style.display="block";e.preventDefault();blobTextInput.focus();};buttonRow.appendChild(fileButton);buttonRow.appendChild(textButton);const fileNameDisplay=document.createElement("div");fileNameDisplay.style.fontSize="14px";fileNameDisplay.style.color="rgba(255, 255, 255, 0.8)";fileNameDisplay.style.marginBottom="10px";fileNameDisplay.style.display="none";blobFileInput.addEventListener("change",function(){if(blobFileInput.files.length>0){fileNameDisplay.textContent=`Selected file: ${blobFileInput.files[0].name}`;fileNameDisplay.style.display="block";blobTextInput.value="";}else{fileNameDisplay.style.display="none";}});container.insertBefore(fileNameDisplay,container.firstChild);container.insertBefore(buttonRow,container.firstChild);}
function toggleWifiPassForm(){if(wifiPassForm.classList.contains("hidden")){wifiPassForm.classList.remove("hidden");wifiPassForm.style.display="block";wifiPassForm.style.maxHeight="0";wifiPassForm.style.opacity="0";wifiPassForm.style.margin="0";void wifiPassForm.offsetWidth;wifiPassForm.style.maxHeight="500px";wifiPassForm.style.opacity="1";wifiPassForm.style.margin="10px 0";}else{wifiPassForm.style.maxHeight="0";wifiPassForm.style.opacity="0";wifiPassForm.style.margin="0";setTimeout(()=>{wifiPassForm.classList.add("hidden");},300);}}
function editFormHandler(e){e.preventDefault();const submitBtn=this.querySelector(".submit-btn");const btnText=submitBtn.querySelector(".btn-text");const loading=submitBtn.querySelector(".loading");btnText.style.opacity="0";loading.classList.remove("hidden");submitBtn.disabled=true;positionSelect.disabled=false;const formData=new FormData(this);if((formData.get("password")||"").match(/^\s*$/)){formData.delete("password");}
formData.delete("lang");const params=new URLSearchParams(formData).toString();fetch("/editPass?"+params).then((response)=>response.text()).catch(errorHandler).finally(async(data)=>{await getPasswords();btnText.style.opacity="1";loading.classList.add("hidden");submitBtn.disabled=false;setMode("type");});}
document.addEventListener("DOMContentLoaded",function(){const handler=()=>{layoutIndex.value=layoutSelect.selectedIndex-1;};layoutSelect.addEventListener("change",handler);handler();editFormContent.addEventListener("submit",editFormHandler);initToggleButtons();initializeRecoveryInputs();});function setupPasswordCardEvents(){const passwordGrid=document.querySelector(".password-grid");let pressTimer;let longPressTriggered=false;let currentCard=null;let touchStartY=0;let touchStartX=0;const longPressDuration=800;const scrollThreshold=10;let isScrolling=false;passwordGrid.removeEventListener("mousedown",handleMouseDown);passwordGrid.removeEventListener("mouseup",handleMouseUp);passwordGrid.removeEventListener("mouseleave",handleMouseLeave);passwordGrid.removeEventListener("touchstart",handleTouchStart);passwordGrid.removeEventListener("touchend",handleTouchEnd);passwordGrid.removeEventListener("touchmove",handleTouchMove);passwordGrid.removeEventListener("touchcancel",handleTouchCancel);passwordGrid.addEventListener("mousedown",handleMouseDown);passwordGrid.addEventListener("mouseup",handleMouseUp);passwordGrid.addEventListener("mouseleave",handleMouseLeave);passwordGrid.addEventListener("touchstart",handleTouchStart);passwordGrid.addEventListener("touchmove",handleTouchMove);passwordGrid.addEventListener("touchend",handleTouchEnd);passwordGrid.addEventListener("touchcancel",handleTouchCancel);function handleMouseDown(e){const card=e.target.closest(".password-card");if(!card)return;currentCard=card;longPressTriggered=false;pressTimer=setTimeout(function(){const passwordId=parseInt(card.dataset.passwordId);handleLongPress(passwordId);longPressTriggered=true;},longPressDuration);}
function handleMouseUp(e){if(!currentCard)return;clearTimeout(pressTimer);if(!longPressTriggered){passwordClick(e);}
currentCard=null;}
function handleMouseLeave(e){if(currentCard){clearTimeout(pressTimer);currentCard=null;}}
function handleTouchStart(e){const card=e.target.closest(".password-card");if(!card)return;const touch=e.touches[0];touchStartY=touch.clientY;touchStartX=touch.clientX;isScrolling=false;currentCard=card;longPressTriggered=false;pressTimer=setTimeout(function(){if(!isScrolling){const passwordId=parseInt(card.dataset.passwordId);handleLongPress(passwordId);longPressTriggered=true;}},longPressDuration);}
function handleTouchMove(e){if(!currentCard)return;const touch=e.touches[0];const moveY=Math.abs(touch.clientY-touchStartY);const moveX=Math.abs(touch.clientX-touchStartX);if(moveY>scrollThreshold||moveX>scrollThreshold){isScrolling=true;clearTimeout(pressTimer);}}
function handleTouchEnd(e){if(!currentCard)return;clearTimeout(pressTimer);if(!longPressTriggered&&!isScrolling){e.preventDefault();passwordClick(e);}
currentCard=null;isScrolling=false;}
function handleTouchCancel(e){if(currentCard){clearTimeout(pressTimer);currentCard=null;isScrolling=false;}}}
function handleLongPress(passwordId){if(ui_data.mode!=="edit"){setMode("edit");}
fillForm({uid:passwordId,name:ui_data.passwords[passwordId].name,layout:ui_data.passwords[passwordId].layout,});showEditForm(passwordId);}
window.onload=async()=>{await checkPassphrase();await getPasswords();setupPasswordCardEvents();document.querySelectorAll(".passwordLength").forEach((el)=>{el.setAttribute("maxlength",MAX_PASSWORD_LENGTH);});};</script>
</body>
</html>
<!-- vim:ts=2:sw=2:et:
-->
